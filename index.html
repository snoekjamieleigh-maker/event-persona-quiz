<script>
console.log("persona-quiz build v9");

// -------- CONFIG: update this when you replace images --------
const IMG_VERSION = "v2"; // bump to v3 next time you upload new images

// -------- Persona images (served from /assets/images) --------
const IMG = {
  Showrunner: `./assets/images/showrunner.webp?${IMG_VERSION}`,
  Connector:  `./assets/images/connector.webp?${IMG_VERSION}`,
  Scientist:  `./assets/images/scientist.webp?${IMG_VERSION}`,
  Host:       `./assets/images/host.webp?${IMG_VERSION}`,
  Rainmaker:  `./assets/images/rainmaker.webp?${IMG_VERSION}`,
  Guardian:   `./assets/images/guardian.webp?${IMG_VERSION}`,
  Amplifier:  `./assets/images/amplifier.webp?${IMG_VERSION}`,
};

// -------- Persona copy --------
const ARCH = {
  Showrunner: {vibe:"bold • high-energy • theatrical", best:"flagship conferences, product launches, big-stage trade shows", kpis:["Peak-session attendance","Qualified meetings","Clip reach"], unlock:["Programming shape","“Headline” moment","Clip plan","Budget watchouts"], cta:"Make your moment land—and last."},
  Connector:  {vibe:"warm • curated • relationship-driven", best:"exec breakfasts, micro-summits, VIP dinners, roadshows", kpis:["Qualified intros","Opps created","Follow-up meetings"], unlock:["Roundtable prompts","Curated-intro workflow","Timebox rules"], cta:"Make the room your moat."},
  Scientist:  {vibe:"smart • practical • proof-seeking", best:"hands-on workshops, training tracks, enablement days", kpis:["Completion rate","CSAT","Enablement adoption"], unlock:["Lab agenda","Materials list","Assessment rubric","Recording plan"], cta:"Teach the thing—don’t pitch the thing."},
  Host:       {vibe:"relaxed • hospitality-first • premium touches", best:"incentive trips, customer retreats, partner offsites", kpis:["Renewal/expansion","NPS","Repeat attendance"], unlock:["Signature moment ideas","Pace map","F&B guardrails","Memory-reel plan"], cta:"Design loyalty you can feel."},
  Rainmaker:  {vibe:"confident • energetic • outcomes-driven", best:"in-booth programming + micro-events around trade shows", kpis:["Meetings booked","SQL rate","Sponsor upgrades"], unlock:["Hourly mini-show loop","Scanner discipline","Lead routing","Clip cues"], cta:"Make the booth a campaign engine."},
  Guardian:   {vibe:"inclusive • thoughtful • steady", best:"association tracks, sponsor showcases, community conferences", kpis:["NPS","ADA satisfaction","Sponsor renewals"], unlock:["Sensory-friendly options","Panel format rules","Sponsor grid cues"], cta:"Experiences that include everyone—and renew sponsors."},
  Amplifier:  {vibe:"editorial • fast-turn • distribution-first", best:"content-capture studios, interview pods, livestream add-ons", kpis:["Clips in 48h","Reach/engagement","Cost per asset"], unlock:["Capture map + shot list","Staffing grid","48-hour clip plan","Release workflow"], cta:"Turn your event into a content engine."},
};

// -------- Weights (small tilt toward Amplifier for event marketing) --------
const W = {
  goals: {
    brand: {Showrunner:3, Amplifier:1, Host:1},
    meetings: {Rainmaker:3, Showrunner:1},
    relationships: {Connector:3, Host:1},
    enablement: {Scientist:3, Amplifier:1},
    sponsor: {Guardian:3, Rainmaker:1},
    content: {Amplifier:4, Showrunner:1, Scientist:1}, // +1 tilt
  },
  setting: {flagship:{Showrunner:2}, booth:{Rainmaker:2}, roadshow:{Connector:2}, workshop:{Scientist:2}, community:{Guardian:2}, retreat:{Host:2}},
  aud: {exec:{Connector:1, Host:1}, practitioner:{Scientist:1, Amplifier:1}, mixed:{}},
  speed: {'48h':{Amplifier:3}, week:{Amplifier:2}, later:{}}, // faster clips → more Amplifier
  access: {high:{Guardian:2} , normal:{}},
  budget: {bigmoment:{Showrunner:2, Host:1}, efficient:{Scientist:1, Rainmaker:1}},
  sales: {heavy:{Rainmaker:2, Showrunner:1}, balanced:{}, light:{Host:1, Guardian:1}},
  eng: {
    spectacle: {Showrunner:2}, minishows: {Rainmaker:2}, curated: {Connector:2},
    hands: {Scientist:2}, chill: {Host:2}, inclusive: {Guardian:2}
  },
  attendance(n){ if(n>=1000) return {Showrunner:2}; if(n>=100) return {Connector:1}; return {Host:1, Scientist:1}; }
};

// -------- Deterministic tie-breaker + marketing tilt --------
const EPS = { Amplifier:0.06, Showrunner:0.05, Connector:0.04, Rainmaker:0.03, Scientist:0.02, Host:0.01, Guardian:0.005 };

function applyMarketingTilt(state, s){
  let amp = 0.5; // baseline nudge for Imprint's event-marketing posture
  if (state.goals.includes('content')) amp += 1.2;
  if (state.speed === '48h') amp += 1.0;
  else if (state.speed === 'week') amp += 0.5;
  if (state.setting === 'retreat') amp -= 0.5; // less central there
  s.Amplifier += Math.max(0, amp);
  return s;
}

// -------- Helpers --------
function addScore(s, m){ Object.entries(m||{}).forEach(([k,v])=> s[k]+=v); }
function pickVal(id){
  const b = document.querySelector('#'+id+' button[aria-pressed="true"]');
  return b ? b.dataset.v : null;
}
function readState(){
  const goals = [...document.querySelectorAll('#goals .pill[data-active="1"]')].map(x=>x.dataset.key);
  const eng = [...document.querySelectorAll('#eng .pill[data-active="1"]')].map(x=>x.dataset.key);
  return {
    goals, eng,
    setting: pickVal('setting'),
    aud: pickVal('aud'),
    speed: pickVal('speed'),
    access: pickVal('access'),
    budget: pickVal('budget'),
    sales: pickVal('sales'),
    att: +document.getElementById('att').value,
  };
}
function encodeState(s){
  const p = new URLSearchParams();
  if(s.goals.length) p.set('goals', s.goals.join(','));
  if(s.eng.length) p.set('eng', s.eng.join(','));
  ['setting','aud','speed','access','budget','sales'].forEach(k=> p.set(k, s[k]));
  p.set('att', s.att);
  return p.toString();
}
function applyState(params){
  const get = (k, d=null)=> params.get(k) ?? d;
  // pills
  const setPills = (id, csv)=>{
    document.querySelectorAll('#'+id+' .pill').forEach(x=> x.setAttribute('data-active','0'));
    (csv||'').split(',').filter(Boolean).slice(0,2).forEach(key=>{
      const el = document.querySelector('#'+id+' .pill[data-key="'+key+'"]'); if(el) el.setAttribute('data-active','1');
    });
  };
  setPills('goals', get('goals',''));
  setPills('eng', get('eng',''));
  // segs
  const setSeg = (id,val)=>{
    const el = document.getElementById(id);
    if(!el) return;
    let done = false;
    [...el.children].forEach(b=>{
      const on = b.dataset.v === val;
      b.setAttribute('aria-pressed', on ? 'true':'false');
      if(on) done=true;
    });
    if(!done) el.children[0]?.setAttribute('aria-pressed','true');
  };
  ['setting','aud','speed','access','budget','sales'].forEach(k=> setSeg(k, get(k, null)));
  // range
  const a = parseInt(get('att', '300'), 10);
  if(!isNaN(a)){ document.getElementById('att').value = a; document.getElementById('attv').textContent = "≈ " + a; }
}

// -------- Scoring + Confidence --------
function score(state){
  const s={Showrunner:0,Connector:0,Scientist:0,Host:0,Rainmaker:0,Guardian:0,Amplifier:0};
  state.goals.forEach(g=> addScore(s, W.goals[g]));
  addScore(s, W.setting[state.setting]);
  addScore(s, W.aud[state.aud]);
  addScore(s, W.speed[state.speed]);
  addScore(s, W.access[state.access]);
  addScore(s, W.budget[state.budget]);
  addScore(s, W.sales[state.sales]);
  state.eng.forEach(e=> addScore(s, W.eng[e]));
  addScore(s, W.attendance(state.att));

  // tie-breaker + tilt
  Object.keys(s).forEach(k=> s[k] += (EPS[k] || 0));
  applyMarketingTilt(state, s);

  return s;
}
function topTwo(scores){
  const arr = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const [a,b] = arr;
  const total = Math.max(1, a[1] + (b ? b[1] : 0));
  const pa = Math.round((a[1]/total)*100);
  const pb = 100 - pa;
  const conf = Math.max(0, Math.min(100, Math.round( (a[1]- (b?b[1]:0)) / (a[1]||1) * 100 )));
  return {a:a[0], b:b?b[0]:a[0], pa, pb, conf};
}
function confidenceLabel(conf){
  if (conf >= 70) return {label:"Very strong match", expl:"Your choices align clearly with one persona."};
  if (conf >= 50) return {label:"Strong match", expl:"Most signals point to one persona."};
  if (conf >= 30) return {label:"Balanced", expl:"You share traits with two personas."};
  return {label:"Close call", expl:"Two personas are nearly tied."};
}
function rationale(state){
  const bits = [];
  if(state.goals.length) bits.push("Goals → " + state.goals.join(" + "));
  bits.push("Setting → " + state.setting);
  bits.push("Engagement → " + (state.eng.join(" + ")||"n/a"));
  bits.push("Audience → " + state.aud);
  bits.push("Speed → " + state.speed);
  if(state.access==="high") bits.push("Accessibility → critical");
  return bits;
}

// -------- Render (winner image, KPIs from BOTH personas) --------
function renderBlend(res, state){
  const container = document.getElementById('result');
  const intro = document.getElementById('resultIntro');
  if (intro) intro.style.display = 'none';

  const c = confidenceLabel(res.conf);
  const heroSrc = IMG[res.a] || "";
  const rlist = rationale(state).map(x=>`<li>${x}</li>`).join("");

  const kpisA = ARCH[res.a].kpis.slice(0,3).map(k=>`<div class='kpi'><h3>${res.a} KPI</h3><div class='v'>${k}</div></div>`).join("");
  const kpisB = ARCH[res.b].kpis.slice(0,3).map(k=>`<div class='kpi'><h3>${res.b} KPI</h3><div class='v'>${k}</div></div>`).join("");

  container.innerHTML = `
  <div class="card fade-in">
    <div class="blend">
      <div>
        <h2>${res.a} <span class="small">(${res.pa}%)</span></h2>
        <div class="kbar"><div class="fill" style="width:${res.pa}%"></div></div>
        <p class="small" style="margin-top:6px">${ARCH[res.a].vibe}</p>
      </div>
      <div>
        <h2>${res.b} <span class="small">(${res.pb}%)</span></h2>
        <div class="kbar"><div class="fill" style="width:${res.pb}%;background:linear-gradient(90deg,#FA5C00,#2C3CC9)"></div></div>
        <p class="small" style="margin-top:6px">${ARCH[res.b].vibe}</p>
      </div>
    </div>

    <p class="small" style="margin-top:8px">
      Confidence: <strong>${res.conf}%</strong>
      <span class="small" style="opacity:.85">— ${c.label}. ${c.expl}</span>
    </p>

    <div class="grid two" style="margin-top:10px">
      <div>
        <img class="hero" id="hero" src="${heroSrc}" alt="${res.a} image">
        <p class="small muted" style="margin-top:6px">Top match image: ${res.a}</p>
      </div>
      <div>
        <h3>Best-fit formats</h3>
        <p class="small"><strong>${res.a}:</strong> ${ARCH[res.a].best}</p>
        <p class="small"><strong>${res.b}:</strong> ${ARCH[res.b].best}</p>

        <h3 style="margin-top:10px">Success KPIs (both personas)</h3>
        <div class="kpis">${kpisA}${kpisB}</div>

        <h3 style="margin-top:10px">Why this match</h3>
        <ul class="small">${rlist}</ul>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="unlock">Unlock plan</button>
          <button class="btn ghost" id="swap">Show ${res.b} image</button>
        </div>
      </div>
    </div>
  </div>`;

  document.getElementById('swap').onclick = () => {
    const hero = document.getElementById('hero');
    const a = IMG[res.a], b = IMG[res.b];
    hero.src = (hero.src.includes(a) ? b : a) || hero.src;
    document.getElementById('swap').textContent =
      hero.src.includes(a) ? `Show ${res.b} image` : `Show ${res.a} image`;
  };
  document.getElementById('unlock').onclick = () => gate(res.a);
}

// -------- UI wiring --------
function setupSeg(id){
  const el = document.getElementById(id);
  el.addEventListener('click', (e)=>{
    if(e.target.tagName !== 'BUTTON') return;
    [...el.children].forEach(b=>b.setAttribute('aria-pressed','false'));
    e.target.setAttribute('aria-pressed','true');
    onChange();
  });
}
["setting","aud","speed","access","budget","sales"].forEach(setupSeg);

function setupPills(id, max=2){
  const el = document.getElementById(id);
  el.addEventListener('click', (e)=>{
    const pill = e.target.closest('.pill'); if(!pill) return;
    const on = pill.getAttribute('data-active') === '1';
    if(on){ pill.setAttribute('data-active','0'); }
    else {
      const active = el.querySelectorAll('[data-active="1"]').length;
      if(active >= max) return;
      pill.setAttribute('data-active','1');
    }
    onChange();
  });
}
setupPills("goals",2); setupPills("eng",2);

// -------- Reset / Copy (stable on GH Pages) --------
document.getElementById('reset').onclick = ()=>{
  const clean = location.origin + location.pathname; // strips ?query safely
  location.replace(clean);
};
document.getElementById('copy').onclick = ()=>{
  navigator.clipboard.writeText(location.href).then(()=>{
    document.getElementById('hint').textContent="Link copied — share it with your team.";
  });
};

// -------- Gate --------
function gate(key){
  const email = prompt("Work email to unlock the plan:");
  if(!email) return;
  const bad = ["gmail.com","yahoo.com","icloud.com","hotmail.com","outlook.com","aol.com","proton.me","pm.me","live.com","me.com"];
  const ok = email.includes("@") && !bad.includes(email.split("@").pop().toLowerCase());
  if(!ok) return alert("Use a work email (no personal domains).");
  alert("Unlocked: " + key + " — we'll bring this into a 15-min blueprint call.");
}

// -------- Live update --------
let firstRun = true;
function onChange(){
  try{
    const state = readState();
    const qs = encodeState(state);
    history.replaceState(null, "", location.pathname + "?" + qs);
    const sc = score(state);
    const res = topTwo(sc);
    renderBlend(res, state);
    if(firstRun){
      const y = document.querySelector('#result').getBoundingClientRect().top + window.scrollY - 10;
      window.scrollTo({top:y,behavior:'smooth'});
    }
    firstRun = false;
  }catch(err){
    console.error("render error:", err);
  }
}

// -------- Init --------
document.addEventListener('DOMContentLoaded', ()=>{
  const params = new URLSearchParams(location.search);
  applyState(params);
  onChange();
});
</script>
